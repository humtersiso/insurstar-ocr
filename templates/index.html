<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保單辨識系統 - Insurance OCR System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 1rem auto;
            padding: 1.5rem;
            max-width: 1400px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .header h1 {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 0.5rem;
        }
        
        .file-input {
            display: none;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .upload-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #5a6268);
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
            font-size: 0.9rem;
        }
        
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
            color: white;
        }
        
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            display: none;
            margin: 2rem 0;
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background: #ecf0f1;
        }
        
        .progress-bar {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border-radius: 15px;
        }
        
        .result-container {
            display: none;
            margin-top: 2rem;
        }
        
        .data-card {
            background: #fff;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3498db;
        }
        
        .data-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-field:last-child {
            border-bottom: none;
        }
        
        .field-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .field-value {
            color: #27ae60;
            font-weight: 500;
        }
        
        .alert {
            border-radius: 15px;
            border: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 保險詳情樣式 */
        .insurance-details-formatted {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 5px;
            border-left: 4px solid #007bff;
        }
        
        .insurance-item {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #007bff;
            font-weight: bold;
            color: #0056b3;
        }
        
        .insurance-detail {
            padding: 5px 0 5px 20px;
            color: #495057;
            line-height: 1.6;
            border-bottom: 1px dotted #dee2e6;
        }
        
        .insurance-detail:last-child {
            border-bottom: none;
        }
        
        .insurance-details-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 5px;
            border-left: 4px solid #007bff;
        }
        
        .field-value {
            max-width: 60%;
            word-wrap: break-word;
        }
        
        .feature-list {
            background: #fff;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .feature-icon {
            font-size: 1.5rem;
            color: #3498db;
            margin-right: 1rem;
            width: 30px;
        }
        
        /* 保險詳情表格樣式 */
        .insurance-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            background: #f8f9fa;
        }
        .insurance-table th, .insurance-table td {
            border: 1.5px solid #007bff;
            padding: 8px 12px;
            text-align: left;
        }
        .insurance-table th {
            background: #e3f0ff;
            color: #0056b3;
            font-weight: bold;
        }
        .insurance-table tr.details-row td {
            background: #f4f8fd;
            color: #333;
            font-size: 0.98em;
        }
        /* 讓保險詳情區塊更寬 */
        .field-value:has(.insurance-table) {
            max-width: 95%;
            display: block;
        }
        body, html {
            background: #e3f2fd !important;
        }
        
        /* 圖片彈框樣式 */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
        }
        
        .image-modal-content {
            position: relative;
            margin: auto;
            display: block;
            max-width: 95%;
            max-height: 95%;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .image-modal-close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        .image-modal-caption {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
        }
        
        #previewImageContainer img {
            background: #fff;
        }
        
        /* 要保書預覽樣式 */
        .preview-placeholder {
            padding: 1rem;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .preview-image:hover {
            transform: scale(1.02);
        }
        
        .preview-caption {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* 緊湊模式樣式 */
        .compact-data .data-field {
            padding: 0.3rem 0;
            font-size: 0.9rem;
        }
        
        .compact-data .field-label {
            font-size: 0.85rem;
        }
        
        .compact-data .field-value {
            font-size: 0.85rem;
        }
        
        .compact-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .compact-card h5 {
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }
        
        /* 減少間距 */
        .result-container .row {
            margin-bottom: 0.5rem;
        }
        
        .result-container .data-card {
            margin-bottom: 0.5rem;
        }
        
        /* 預覽圖片高度限制 */
        .preview-image {
            max-height: 200px;
            max-width: 100%;
        }
        
        /* 保險表格緊湊化 */
        .compact-data .insurance-table {
            font-size: 0.8rem;
        }
        
        .compact-data .insurance-table th,
        .compact-data .insurance-table td {
            padding: 4px 6px;
        }
        
        .custom-download-btn {
            font-size: 1rem;
            padding: 0.5rem 1.2rem;
        }
        .custom-download-btn i {
            font-size: 1.2em;
        }
        .custom-download-btn-sm {
            font-size: 0.85rem;
            padding: 0.25rem 0.7rem;
        }
        .custom-download-btn-sm i {
            font-size: 1.1em;
        }
        /* 現代卡片樣式 */
        .modern-card {
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 1.2rem;
            padding: 1.2rem;
            border-left: 5px solid #3498db;
            box-shadow: 0 3px 12px rgba(52, 152, 219, 0.1);
            transition: all 0.3s ease;
        }
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.15);
        }
        .card-header-modern {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.8rem;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }
        .data-field-modern {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .data-field-modern:last-child {
            border-bottom: none;
        }
        .field-label-modern {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }
        .field-value-modern {
            color: #27ae60;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }

        /* 簡約卡片樣式 */
        .minimal-card {
            background: #ffffff;
            border-radius: 8px;
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            box-shadow: none;
        }
        .card-header-minimal {
            font-size: 1rem;
            color: #212529;
            margin-bottom: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .data-field-minimal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
        }
        .field-label-minimal {
            font-weight: 400;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .field-value-minimal {
            color: #212529;
            font-weight: 400;
            text-align: right;
            max-width: 60%;
        }

        /* 彩色卡片樣式 */
        .colorful-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin-bottom: 1.2rem;
            padding: 1.2rem;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .card-header-colorful {
            font-size: 1.1rem;
            color: white;
            margin-bottom: 0.8rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .data-field-colorful {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .data-field-colorful:last-child {
            border-bottom: none;
        }
        .field-label-colorful {
            font-weight: 500;
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }
        .field-value-colorful {
            color: white;
            font-weight: 600;
            text-align: right;
            max-width: 60%;
        }

        /* 邊框卡片樣式 */
        .bordered-card {
            background: #ffffff;
            border-radius: 10px;
            margin-bottom: 1.2rem;
            padding: 1.2rem;
            border: 2px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .card-header-bordered {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 0.8rem;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        .data-field-bordered {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .data-field-bordered:last-child {
            border-bottom: none;
        }
        .field-label-bordered {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }
        .field-value-bordered {
            color: #28a745;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }

        /* 漸層卡片樣式 */
        .gradient-card {
            background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 15px;
            margin-bottom: 1.2rem;
            padding: 1.2rem;
            box-shadow: 0 4px 15px rgba(255, 154, 158, 0.3);
        }
        .card-header-gradient {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.8rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }
        .data-field-gradient {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid rgba(44, 62, 80, 0.1);
        }
        .data-field-gradient:last-child {
            border-bottom: none;
        }
        .field-label-gradient {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        .field-value-gradient {
            color: #34495e;
            font-weight: 500;
            text-align: right;
            max-width: 60%;
        }

        /* 原始樣式保留作為備用 */
        .data-section {
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 1.2rem;
            padding: 1rem 1.2rem;
            border-left: 5px solid #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.05);
        }
        .data-section .fw-bold {
            font-size: 1.08rem;
            color: #2c3e50;
            margin-bottom: 0.7rem;
        }

        /* 移除卡片框線、背景、圓角、陰影等樣式 */
        .data-section, .modern-card, .minimal-card, .colorful-card, .bordered-card, .gradient-card {
            background: none !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin-bottom: 0.5rem !important;
        }
        .card-header-modern, .card-header-minimal, .card-header-colorful, .card-header-bordered, .card-header-gradient {
            background: none !important;
            border-bottom: none !important;
            font-size: 1.08rem;
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 0.3rem;
            padding: 0.2rem 0 0.2rem 0.1rem;
        }
        .section-content {
            padding-left: 2.2rem;
            padding-bottom: 0.5rem;
        }
        .data-field-modern, .data-field-minimal, .data-field-colorful, .data-field-bordered, .data-field-gradient {
            border-bottom: 1px solid #ececec;
            padding: 0.3rem 0;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }
        .data-field-modern:last-child, .data-field-minimal:last-child, .data-field-colorful:last-child, .data-field-bordered:last-child, .data-field-gradient:last-child {
            border-bottom: none;
        }
        .field-label-modern, .field-label-minimal, .field-label-colorful, .field-label-bordered, .field-label-gradient {
            font-weight: 500;
            color: #555;
            min-width: 6.5em;
            margin-right: 1.2em;
        }
        .field-value-modern, .field-value-minimal, .field-value-colorful, .field-value-bordered, .field-value-gradient {
            color: #222;
            font-weight: 400;
            text-align: left;
            max-width: 70%;
            word-break: break-all;
        }
        /* 綠色字樣式 */
        .text-success { color: #27ae60 !important; }
        .text-danger { color: #c0392b !important; }
        /* 移除 hover 動畫 */
        .card-header-modern:hover, .card-header-minimal:hover, .card-header-colorful:hover, .card-header-bordered:hover, .card-header-gradient:hover {
            background: none !important;
            color: inherit !important;
            box-shadow: none !important;
            transform: none !important;
        }
        .data-section:hover, .modern-card:hover, .minimal-card:hover, .colorful-card:hover, .bordered-card:hover, .gradient-card:hover {
            background: none !important;
            box-shadow: none !important;
            transform: none !important;
        }
        /* 下載按鈕點擊時不閃爍 */
        .custom-download-btn-sm:focus, .custom-download-btn-sm:active {
            outline: none !important;
            box-shadow: none !important;
            background: inherit !important;
            color: inherit !important;
            border-color: inherit !important;
        }
        /* 強力覆蓋 Bootstrap 按鈕 :active/:focus 狀態，防止閃爍 */
        .btn:active, .btn:focus, .btn:active:focus, .btn-outline-primary:active, .btn-outline-danger:active, .btn-outline-primary:focus, .btn-outline-danger:focus {
            background: inherit !important;
            color: inherit !important;
            border-color: inherit !important;
            box-shadow: none !important;
            outline: none !important;
            transition: none !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 標題區域 -->
            <div class="header">
                <h1><i class="fas fa-file-contract"></i> 保單辨識系統</h1>
                <p>使用AI技術自動辨識保單內容並生成Word文件</p>
            </div>

            <!-- 上傳區塊 -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h5>拖拽檔案到此處或點擊選擇檔案</h5>
                        <p class="text-muted small">支援格式：JPG, PNG, PDF, TIFF, BMP (最大16MB)</p>
                        <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png,.pdf,.tiff,.bmp">
                        <div class="upload-buttons">
                            <button class="btn btn-primary" onclick="selectFile()">
                                <i class="fas fa-folder-open"></i> 選擇檔案
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="data-card compact-card">
                        <h5><i class="fas fa-chart-pie"></i> 處理摘要</h5>
                        <div id="dataSummary">
                            <div class="text-muted">上傳檔案後顯示摘要</div>
                        </div>
                    </div>
                    <div class="data-card compact-card">
                        <h5><i class="fas fa-exclamation-triangle"></i> 提醒事項</h5>
                        <div id="remindersInfo">
                            <div class="text-muted">上傳檔案後顯示提醒</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 進度條 -->
            <div class="progress-container" id="progressContainer">
                <h5><i class="fas fa-cog loading-spinner"></i> 正在處理中...</h5>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
                <p class="text-muted mt-2" id="progressText">準備處理...</p>
            </div>

            <!-- 結果區域 -->
            <div class="result-container" id="resultContainer">
                <!-- 主要內容區域：提取資料 + 預覽 + 生成按鈕 -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="data-card">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-table"></i> 提取的資料</h5>
                            </div>
                            <div id="extractedData" class="compact-data"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="data-card">
                            <h5><i class="fas fa-file-contract"></i> 要保書預覽</h5>
                            <div id="previewImageContainer" class="text-center">
                                <div class="preview-placeholder">
                                    <i class="fas fa-image" style="font-size: 2rem; color: #ccc;"></i>
                                    <p class="text-muted mt-1 small">上傳檔案後顯示預覽</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 財產分析書預覽卡片 -->
                        <div class="data-card mt-3" id="propertyReportPreviewCard">
                            <h5><i class="fas fa-eye"></i> 財產分析書預覽</h5>
                            <div id="propertyReportStatus" class="mb-2 text-center text-info" style="font-size:0.95rem;"></div>
                            <div id="propertyReportPreviewImageContainer" class="text-center" style="margin-top:10px;">
                                <div id="propertyReportPreviewPlaceholder" class="preview-placeholder">
                                    <i class="fas fa-image" style="font-size: 2rem; color: #ccc;"></i>
                                    <p class="text-muted mt-1 small">尚未產生財產分析書預覽，請稍後再試</p>
                                </div>
                                <img id="propertyReportPreviewImage" src="" class="preview-image mx-auto d-block" style="display:none;cursor:pointer;" onclick="openImageModal(this.src)">
                                <div class="preview-caption text-center" id="propertyReportPreviewCaption" style="display:none;">
                                    <i class="fas fa-search-plus"></i> 點擊放大查看
                                    </div>
                                    </div>
                                </div>
                        <!-- 財產分析書下載卡片 -->
                        <div class="data-card mt-3" id="propertyReportDownloadCard">
                            <h5><i class="fas fa-download"></i> 財產分析書下載</h5>
                            <div class="d-flex justify-content-center gap-3 flex-wrap">
                                <button type="button" class="btn btn-outline-primary custom-download-btn-sm" id="downloadWordBtn" onclick="downloadPropertyReport('word', event)" disabled>
                                    <i class="fas fa-file-word" style="color:#2b579a;"></i> 下載 Word
                                </button>
                                <button type="button" class="btn btn-outline-danger custom-download-btn-sm" id="downloadPdfBtn" onclick="downloadPropertyReport('pdf', event)" disabled>
                                    <i class="fas fa-file-pdf" style="color:#c00;"></i> 下載 PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>

            <!-- 功能特色（移到更下方） -->
            <div class="feature-list mt-4" style="opacity: 0.8;">
                <h5><i class="fas fa-star"></i> 系統特色</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="feature-item">
                            <i class="fas fa-eye feature-icon"></i>
                            <span>高精度OCR文字辨識</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="feature-item">
                            <i class="fas fa-file-word feature-icon"></i>
                            <span>自動生成Word文件</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="feature-item">
                            <i class="fas fa-shield-alt feature-icon"></i>
                            <span>資料驗證與錯誤檢查</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="feature-item">
                            <i class="fas fa-chart-line feature-icon"></i>
                            <span>處理摘要報告</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 圖片彈框 -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img class="image-modal-content" id="modalImage">
        <div class="image-modal-caption" id="modalCaption">疊加輔助線圖片</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全域變數
        let currentFile = null;
        let processingResult = null;
        let currentPreviewImageUrl = null;
        let currentOriginalImageUrl = null;
        let currentWordFile = null;
        let currentAnalysisFile = null;
        let currentFileId = null;
        let currentPreviewWordFilename = null;
        let pdfStatusInterval = null;

        // DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultContainer = document.getElementById('resultContainer');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalCaption = document.getElementById('modalCaption');

        // 事件監聽器
        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        // 移除重複的點擊事件監聽器，避免雙重觸發

        // 檔案選擇處理
        function selectFile() {
            fileInput.click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // 拖拽處理
        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        // 檔案處理
        function processFile(file) {
            // 驗證檔案
            if (!validateFile(file)) {
                return;
            }

            currentFile = file;
            currentPreviewImageUrl = null;
            currentOriginalImageUrl = null;
            
            // 重置狀態
            currentPreviewImageUrl = null;
            currentOriginalImageUrl = null;
            
            // 清空處理摘要和提醒事項
            const dataSummaryContainer = document.getElementById('dataSummary');
            const remindersContainer = document.getElementById('remindersInfo');
            const extractedDataContainer = document.getElementById('extractedData');
            const previewContainer = document.getElementById('previewImageContainer');
            
            if (dataSummaryContainer) dataSummaryContainer.innerHTML = '';
            if (remindersContainer) remindersContainer.innerHTML = '';
            if (extractedDataContainer) extractedDataContainer.innerHTML = '';
            if (previewContainer) previewContainer.innerHTML = '';
            
            // 禁用生成財產分析書按鈕
            const generateAnalysisButton = document.getElementById('generateAnalysisButton');
            if (generateAnalysisButton) generateAnalysisButton.disabled = true;
            
            resetPropertyReportPreview();
            currentPreviewWordFilename = null;
            
            showProgress();
            uploadFile(file);
        }

        // 檔案驗證
        function validateFile(file) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/tiff', 'image/bmp', 'application/pdf'];
            const maxSize = 16 * 1024 * 1024; // 16MB

            if (!allowedTypes.includes(file.type)) {
                showAlert('錯誤', '不支援的檔案格式。請選擇 JPG, PNG, PDF, TIFF 或 BMP 檔案。', 'danger');
                return false;
            }

            if (file.size > maxSize) {
                showAlert('錯誤', '檔案大小超過限制 (最大16MB)。', 'danger');
                return false;
            }

            return true;
        }

        // 顯示進度
        function showProgress() {
            progressContainer.style.display = 'block';
            resultContainer.style.display = 'none';
            updateProgress(0, '準備上傳檔案...');
            
            // 確保在顯示進度時清空所有結果區域
            const dataSummaryContainer = document.getElementById('dataSummary');
            const remindersContainer = document.getElementById('remindersInfo');
            const extractedDataContainer = document.getElementById('extractedData');
            const previewContainer = document.getElementById('previewImageContainer');
            
            if (dataSummaryContainer) dataSummaryContainer.innerHTML = '';
            if (remindersContainer) remindersContainer.innerHTML = '';
            if (extractedDataContainer) extractedDataContainer.innerHTML = '';
            if (previewContainer) previewContainer.innerHTML = '';
        }

        // 更新進度
        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
        }

        // 上傳檔案
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            updateProgress(20, '上傳檔案中...');

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                updateProgress(100, '處理完成！');
                setTimeout(() => {
                    showResult(data);
                }, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('錯誤', '處理失敗: ' + error.message, 'danger');
                hideProgress();
            });
        }

        // 顯示結果
        function showResult(data) {
            processingResult = data;
            currentPreviewImageUrl = data.overlay_preview_image_url;
            currentOriginalImageUrl = data.original_preview_image_url;
            currentFileId = data.file_id;
            hideProgress();
            displayExtractedData(data.extracted_data);
            displayDataSummary(data.data_summary);
            displayRemindersInfo(data.reminders);
            // 顯示要保書預覽
            displayPolicyPreview(data.overlay_preview_image_url);
            resultContainer.style.display = 'block';
            // === 財產分析書下載卡片啟用 ===
            if (data && data.word_filename) {
                document.getElementById('downloadWordBtn').disabled = false;
                if (data.pdf_filename) {
                    document.getElementById('downloadPdfBtn').disabled = false;
                }
                currentPreviewWordFilename = data.word_filename;
                previewPropertyReport();
                // PDF 狀態提示
                if (data.pdf_filename) {
                    pollPdfStatus(data.pdf_filename);
                } else {
                    pollPdfStatus(null);
                }
            } else {
                pollPdfStatus(null);
            }
        }

        // 隱藏進度
        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        // 開啟圖片彈框
        function openImageModal(imageUrl) {
            modalImage.src = imageUrl;
            modalCaption.textContent = '要保書預覽 - 點擊外部區域或 X 關閉';
            imageModal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // 防止背景滾動
        }

        // 關閉圖片彈框
        function closeImageModal() {
            imageModal.style.display = 'none';
            document.body.style.overflow = 'auto'; // 恢復背景滾動
        }

        // 點擊彈框外部關閉
        imageModal.addEventListener('click', function(event) {
            if (event.target === imageModal) {
                closeImageModal();
            }
        });

        // ESC鍵關閉彈框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && imageModal.style.display === 'block') {
                closeImageModal();
            }
        });

        // 顯示提取的資料
        function displayExtractedData(data) {
            const container = document.getElementById('extractedData');
            const selectedStyle = 'modern';
            // 分區欄位
            const insuredFields = [
                'insured_person', 'id_number', 'birth_date', 'gender', 'legal_representative'
            ];
            const policyholderFields = [
                'policyholder', 'policyholder_id', 'policyholder_birth_date', 'policyholder_gender', 'policyholder_legal_representative', 'relationship'
            ];
            const otherFields = [
                'insurance_company', 'vehicle_type', 'license_number', 'total_premium', 'compulsory_insurance_period', 'optional_insurance_period'
            ];
            // 欄位標籤
            const fieldLabels = {
                'insurance_company': '產險公司',
                'insured_person': '被保險人',
                'legal_representative': '法人代表人',
                'id_number': '身分證字號/統編',
                'birth_date': '出生日期',
                'gender': '性別',
                'policyholder': '要保人',
                'relationship': '與被保險人關係',
                'policyholder_legal_representative': '法人代表人',
                'policyholder_gender': '性別',
                'policyholder_id': '身分證字號/統編',
                'policyholder_birth_date': '出生日期',
                'vehicle_type': '車輛種類',
                'license_number': '牌照號碼',
                'total_premium': '總保險費',
                'compulsory_insurance_period': '強制險保期',
                'optional_insurance_period': '任意險保期',
                'coverage_items': '承保內容'
            };
            // ICON 對應
            const sectionIcons = {
                '被保人資訊': '<i class="fas fa-user"></i>',
                '要保人資訊': '<i class="fas fa-user-tie"></i>',
                '其他資訊': '<i class="fas fa-info-circle"></i>',
                '承保內容': '<i class="fas fa-clipboard-list"></i>'
            };
            // 收合狀態追蹤
            if (!window.sectionCollapseState) window.sectionCollapseState = {};
            // 將 toggleSectionCollapse 移到全域
            window.toggleSectionCollapse = function(key) {
                let collapsed = window.sectionCollapseState[key];
                if (typeof collapsed === 'undefined') collapsed = true;
                window.sectionCollapseState[key] = !collapsed;
                displayExtractedData(window.currentExtractedData);
            };
            // 渲染分區
            function renderSection(title, fields, key) {
                // 預設展開，點擊立即切換
                let collapsed = window.sectionCollapseState[key];
                if (typeof collapsed === 'undefined') collapsed = true;
                let html = `<div class=\"data-section ${selectedStyle}-card mb-3\">\n` +
                    `<div class=\"card-header-${selectedStyle} d-flex align-items-center\" style=\"cursor:pointer;user-select:none;\" onclick=\"toggleSectionCollapse('${key}')\">` +
                    `<span style=\"margin-right:8px;\">${sectionIcons[title] || ''}</span>` +
                    `<span>${title}</span>` +
                    `<span class=\"ms-auto\"><i class=\"fas fa-chevron-${collapsed ? 'down' : 'right'}\"></i></span>` +
                    `</div>`;
                html += `<div class=\"section-content\" style=\"display:${collapsed ? 'block' : 'none'};transition:all 0.3s;\">`;
                fields.forEach(key => {
                if (data.hasOwnProperty(key)) {
                    let value = data[key] || '未填寫';
                        let valueClass = `field-value-${selectedStyle}`;
                        if (typeof value === 'string' && (value.trim() === '未填寫' || value.trim() === '無填寫')) {
                        valueClass += ' text-danger';
                        } else {
                            valueClass += ' text-success';
                    }
                        html += `<div class=\"data-field-${selectedStyle}\"><span class=\"field-label-${selectedStyle}\">${fieldLabels[key] || key}</span><span class=\"${valueClass}\">${value}</span></div>`;
                    }
                });
                html += '</div></div>';
                return html;
            }
            let html = '';
            html += renderSection('被保人資訊', insuredFields, 'insured');
            html += renderSection('要保人資訊', policyholderFields, 'policyholder');
            html += renderSection('其他資訊', otherFields, 'other');
            // 承保內容（表格）
            if (data.hasOwnProperty('coverage_items')) {
                const collapsed = window.sectionCollapseState['coverage'] === false ? false : true;
                html += `<div class="data-section ${selectedStyle}-card mb-3">
                    <div class="card-header-${selectedStyle} d-flex align-items-center" style="cursor:pointer;user-select:none;" onclick="toggleSectionCollapse('coverage')">
                        <span style="margin-right:8px;">${sectionIcons['承保內容']}</span>
                        <span>承保內容</span>
                        <span class="ms-auto"><i class="fas fa-chevron-${collapsed ? 'down' : 'right'}"></i></span>
                    </div>
                    <div class="section-content" style="display:${collapsed ? 'block' : 'none'};transition:all 0.3s;">${formatCoverageItems(data['coverage_items'])}</div>
                </div>`;
            }
            container.innerHTML = html;
            window.currentExtractedData = data;
        }

        // 專門渲染 coverage_items 陣列為表格
        function formatCoverageItems(items) {
            if (!items || !Array.isArray(items) || items.length === 0) {
                return '無資料';
            }
            let tableHtml = `
                <table class="insurance-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>保險種類</th>
                            <th>保險金額</th>
                            <th>自負額</th>
                            <th>簽單保費</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach((item, idx) => {
                tableHtml += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item['保險種類'] || ''}</td>
                        <td>${item['保險金額'] || ''}</td>
                        <td>${item['自負額'] || ''}</td>
                        <td>${item['簽單保費'] || ''}</td>
                    </tr>
                `;
                // 處理子項目
                if (Array.isArray(item.sub_items)) {
                    item.sub_items.forEach(sub => {
                        // 處理子項目可能是字串或物件的情況
                        let subText = '';
                        let subAmount = '';
                        let subDeductible = '';
                        let subPremium = '';
                        if (typeof sub === 'string') {
                            subText = sub;
                        } else if (sub && typeof sub === 'object') {
                            subText = sub['保險種類'] || sub['item_name'] || '';
                            subAmount = sub['保險金額'] || '';
                            subDeductible = sub['自負額'] || '';
                            subPremium = sub['簽單保費'] || '';
                        }
                        if (subText) {
                            tableHtml += `
                                <tr class="sub-item-row">
                                    <td></td>
                                    <td>└ ${subText}</td>
                                    <td>${subAmount}</td>
                                    <td>${subDeductible}</td>
                                    <td>${subPremium}</td>
                                </tr>
                            `;
                        }
                    });
                }
            });
            tableHtml += `</tbody></table>`;
            return tableHtml;
        }
        
        // 顯示資料摘要
        function displayDataSummary(summary) {
            const container = document.getElementById('dataSummary');
            container.innerHTML = `
                <div class="data-field">
                    <span class="field-label">總欄位數:</span>
                    <span class="field-value">${summary.total_fields}</span>
                </div>
                <div class="data-field">
                    <span class="field-label">已填寫:</span>
                    <span class="field-value">${summary.filled_fields}</span>
                </div>
                <div class="data-field">
                    <span class="field-label">完成率:</span>
                    <span class="field-value">${summary.completion_rate}</span>
                </div>
            `;
        }

        // 顯示提醒事項
        function displayRemindersInfo(reminders) {
            const container = document.getElementById('remindersInfo');
            if (!reminders || reminders.length === 0) {
                container.innerHTML = '<div class="text-success"><i class="fas fa-check-circle"></i> 無需特別提醒</div>';
                return;
            }

            let html = '';
            reminders.forEach(reminder => {
                let iconClass = 'fas fa-info-circle';
                let textClass = 'text-info';
                
                if (reminder.includes('沒有辨識到') || reminder.includes('未辨識到')) {
                    iconClass = 'fas fa-exclamation-triangle';
                    textClass = 'text-warning';
                } else if (reminder.includes('所有保險項目和保期都已成功辨識')) {
                    iconClass = 'fas fa-check-circle';
                    textClass = 'text-success';
                } else if (reminder.includes('無法產生預覽圖')) {
                    iconClass = 'fas fa-times-circle';
                    textClass = 'text-danger';
                }

                html += `
                    <div class="${textClass} mb-2">
                        <i class="${iconClass}"></i> ${reminder}
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        // 顯示要保書預覽
        function displayPolicyPreview(imageUrl) {
            const container = document.getElementById('previewImageContainer');
            if (!container) return;
            // 強制刷新：每次加上時間戳參數
            const ts = Date.now();
            container.innerHTML = `
                <img src="${imageUrl}?t=${ts}" alt="要保書預覽" class="preview-image" onclick="openImageModal('${imageUrl}?t=${ts}')">
                <div class="preview-caption">
                    <i class="fas fa-search-plus"></i> 點擊放大查看
                </div>
            `;
        }

        // 顯示警告
        function showAlert(title, message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <strong>${title}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.main-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 自動關閉
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Word 生成功能
        function generateWord() {
            if (!processingResult || !currentPreviewImageUrl) {
                showAlert('錯誤', '沒有可用的處理結果', 'danger');
                return;
            }

            const generateWordButton = document.getElementById('generateWordButton');
            const downloadWordButton = document.getElementById('downloadWordButton');
            const wordStatus = document.getElementById('wordStatus');

            // 禁用按鈕並顯示載入狀態
            generateWordButton.disabled = true;
            generateWordButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            wordStatus.innerHTML = '<div class="text-info"><i class="fas fa-info-circle"></i> 正在生成 Word 檔案...</div>';

            // 發送請求到後端
            fetch('/api/generate-word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_path: currentPreviewImageUrl.replace('/temp_previews/', 'temp_previews/')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentWordFile = data.word_filename;
                    wordStatus.innerHTML = `
                        <div class="text-success">
                            <i class="fas fa-check-circle"></i> Word 檔案生成成功！
                            <br><small>檔案名稱: ${data.word_filename}</small>
                        </div>
                    `;
                    downloadWordButton.style.display = 'inline-block';
                    generateWordButton.style.display = 'none';
                } else {
                    throw new Error(data.error || '生成失敗');
                }
            })
            .catch(error => {
                console.error('Word 生成錯誤:', error);
                wordStatus.innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-times-circle"></i> 生成失敗: ${error.message}
                    </div>
                `;
                generateWordButton.disabled = false;
                generateWordButton.innerHTML = '<i class="fas fa-file-word"></i> 重新生成 Word 檔案';
            });
        }

        // 生成財產分析書功能
        function generatePropertyAnalysis() {
            if (!processingResult || !processingResult.extracted_data) {
                showAlert('錯誤', '沒有可用的處理結果', 'danger');
                return;
            }

            // 檢查 extracted_data 是否為空或無效
            const extractedData = processingResult.extracted_data;
            if (!extractedData || Object.keys(extractedData).length === 0) {
                showAlert('錯誤', '沒有可用的提取資料，請重新上傳檔案', 'danger');
                return;
            }

            const generateAnalysisButton = document.getElementById('generateAnalysisButton');
            const analysisStatus = document.getElementById('analysisStatus');

            // 禁用按鈕並顯示載入狀態
            generateAnalysisButton.disabled = true;
            generateAnalysisButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
            analysisStatus.innerHTML = '<div class="text-info"><i class="fas fa-info-circle"></i> 正在生成財產分析書...</div>';

            // 發送請求到後端
            fetch('/api/generate-property-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    extracted_data: extractedData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentAnalysisFile = data.analysis_filename;
                    analysisStatus.innerHTML = `
                        <div class="text-success">
                            <i class="fas fa-check-circle"></i> 財產分析書生成成功！
                            <br><small>檔案名稱: ${data.analysis_filename}</small>
                        </div>
                    `;
                    
                    // 切換到預覽狀態
                    showAnalysisPreview();
                } else {
                    throw new Error(data.error || '生成失敗');
                }
            })
            .catch(error => {
                console.error('財產分析書生成錯誤:', error);
                analysisStatus.innerHTML = `
                    <div class="text-danger">
                        <i class="fas fa-times-circle"></i> 生成失敗: ${error.message}
                    </div>
                `;
                generateAnalysisButton.disabled = false;
                generateAnalysisButton.innerHTML = '<i class="fas fa-file-word"></i> 重新生成財產分析書';
            });
        }

        // 下載財產分析書功能
        function downloadAnalysis() {
            if (!currentAnalysisFile) {
                showAlert('錯誤', '沒有可下載的財產分析書', 'danger');
                return;
            }

            // 建立下載連結
            const downloadUrl = `/download/${currentAnalysisFile}`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = currentAnalysisFile;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('成功', '財產分析書下載已開始', 'success');
        }

        // Word 下載功能
        function downloadWord() {
            if (!currentWordFile) {
                showAlert('錯誤', '沒有可下載的 Word 檔案', 'danger');
                return;
            }

            // 建立下載連結
            const downloadUrl = `/download/${currentWordFile}`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = currentWordFile;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('成功', 'Word 檔案下載已開始', 'success');
        }

        // 財產分析書預覽功能
        function previewPropertyReport() {
            if (!processingResult || !processingResult.word_filename) {
                showAlert('錯誤', '財產分析書尚未產生', 'danger');
                return;
            }
            const thisPreviewWordFilename = processingResult.word_filename;
            fetch('/api/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: thisPreviewWordFilename })
            })
            .then(res => res.json())
            .then(data => {
                if (currentPreviewWordFilename !== thisPreviewWordFilename) return;
                const img = document.getElementById('propertyReportPreviewImage');
                const placeholder = document.getElementById('propertyReportPreviewPlaceholder');
                const caption = document.getElementById('propertyReportPreviewCaption');
                if (data.preview_url) {
                    img.src = data.preview_url + '?t=' + Date.now();
                    img.style.display = 'block';
                    caption.style.display = 'block';
                    placeholder.style.display = 'none';
                } else {
                    img.style.display = 'none';
                    img.src = '';
                    caption.style.display = 'none';
                    placeholder.style.display = 'block';
                }
            })
            .catch(() => {
                if (currentPreviewWordFilename !== thisPreviewWordFilename) return;
                const img = document.getElementById('propertyReportPreviewImage');
                const placeholder = document.getElementById('propertyReportPreviewPlaceholder');
                const caption = document.getElementById('propertyReportPreviewCaption');
                if (img) {
                    img.style.display = 'none';
                    img.src = '';
                }
                if (caption) caption.style.display = 'none';
                if (placeholder) placeholder.style.display = 'block';
            });
        }

        // 財產分析書下載功能
        function downloadPropertyReport(type, event) {
            if (event) event.preventDefault();
            if (!processingResult || !processingResult.word_filename) {
                showAlert('錯誤', '財產分析書尚未產生', 'danger');
                return;
            }
            let filename = (type === 'pdf' && processingResult.pdf_filename)
                ? processingResult.pdf_filename
                : processingResult.word_filename;
            // 用隱藏 a 標籤下載，不開新分頁
            const link = document.createElement('a');
            link.href = '/download/' + filename;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 更新財產分析書生成成功後的顯示
        function showAnalysisPreview() {
            const generateState = document.getElementById('analysisGenerateState');
            const previewState = document.getElementById('analysisPreviewState');
            
            // 隱藏生成狀態，顯示預覽狀態
            generateState.style.display = 'none';
            previewState.style.display = 'block';
        }

        function resetPropertyReportPreview() {
            // 清空預覽圖
            const img = document.getElementById('propertyReportPreviewImage');
            const placeholder = document.getElementById('propertyReportPreviewPlaceholder');
            const caption = document.getElementById('propertyReportPreviewCaption');
            if (img) {
                img.style.display = 'none';
                img.src = '';
            }
            if (caption) caption.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';
            // 禁用下載按鈕
            const downloadWordBtn = document.getElementById('downloadWordBtn');
            if (downloadWordBtn) downloadWordBtn.disabled = true;
            currentPreviewWordFilename = null;
        }

        function pollPdfStatus(pdfFilename) {
            clearInterval(pdfStatusInterval);
            const statusDiv = document.getElementById('propertyReportStatus');
            if (!pdfFilename) {
                statusDiv.textContent = '';
                return;
            }
            statusDiv.textContent = 'PDF 產生中...';
            pdfStatusInterval = setInterval(() => {
                fetch('/download/' + pdfFilename, { method: 'HEAD' })
                    .then(res => {
                        if (res.ok) {
                            statusDiv.textContent = 'PDF 產生完成，可供預覽/下載';
                            clearInterval(pdfStatusInterval);
                        } else {
                            statusDiv.textContent = 'PDF 產生中...';
                        }
                    })
                    .catch(() => {
                        statusDiv.textContent = 'PDF 產生失敗';
                        clearInterval(pdfStatusInterval);
                    });
            }, 1500);
        }

        // 樣式切換函數
        function changeCardStyle() {
            const currentData = window.currentExtractedData;
            if (currentData) {
                displayExtractedData(currentData);
            }
        }
        
        // 儲存當前提取的資料
        window.currentExtractedData = null;
    </script>
</body>
</html> 