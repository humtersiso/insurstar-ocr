<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保單辨識系統 - Insurance OCR System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            padding: 2rem;
            max-width: 1200px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 3rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }
        
        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #3498db;
            margin-bottom: 1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .progress-container {
            display: none;
            margin: 2rem 0;
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background: #ecf0f1;
        }
        
        .progress-bar {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border-radius: 15px;
        }
        
        .result-container {
            display: none;
            margin-top: 2rem;
        }
        
        .data-card {
            background: #fff;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3498db;
        }
        
        .data-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .data-field:last-child {
            border-bottom: none;
        }
        
        .field-label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .field-value {
            color: #27ae60;
            font-weight: 500;
        }
        
        .validation-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .validation-success {
            background: #d4edda;
            color: #155724;
        }
        
        .validation-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .validation-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .download-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .btn-download {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
            color: white;
        }
        
        .alert {
            border-radius: 15px;
            border: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 保險詳情樣式 */
        .insurance-details-formatted {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 5px;
            border-left: 4px solid #007bff;
        }
        
        .insurance-item {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 10px;
            margin: 8px 0;
            border-left: 3px solid #007bff;
            font-weight: bold;
            color: #0056b3;
        }
        
        .insurance-detail {
            padding: 5px 0 5px 20px;
            color: #495057;
            line-height: 1.6;
            border-bottom: 1px dotted #dee2e6;
        }
        
        .insurance-detail:last-child {
            border-bottom: none;
        }
        
        .insurance-details-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 5px;
            border-left: 4px solid #007bff;
        }
        
        .field-value {
            max-width: 60%;
            word-wrap: break-word;
        }
        
        .feature-list {
            background: #fff;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .feature-icon {
            font-size: 1.5rem;
            color: #3498db;
            margin-right: 1rem;
            width: 30px;
        }
        
        /* 保險詳情表格樣式 */
        .insurance-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            background: #f8f9fa;
        }
        .insurance-table th, .insurance-table td {
            border: 1.5px solid #007bff;
            padding: 8px 12px;
            text-align: left;
        }
        .insurance-table th {
            background: #e3f0ff;
            color: #0056b3;
            font-weight: bold;
        }
        .insurance-table tr.details-row td {
            background: #f4f8fd;
            color: #333;
            font-size: 0.98em;
        }
        /* 讓保險詳情區塊更寬 */
        .field-value:has(.insurance-table) {
            max-width: 95%;
            display: block;
        }
        body, html {
            background: #e3f2fd !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 標題區域 -->
            <div class="header">
                <h1><i class="fas fa-file-contract"></i> 保單辨識系統</h1>
                <p>使用AI技術自動辨識保單內容並生成PDF表單</p>
            </div>

            <!-- 上傳區域 -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <h4>拖拽檔案到此處或點擊選擇檔案</h4>
                <p class="text-muted">支援格式：JPG, PNG, PDF, TIFF, BMP (最大16MB)</p>
                <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png,.pdf,.tiff,.bmp">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-folder-open"></i> 選擇檔案
                </button>
            </div>

            <!-- 進度條 -->
            <div class="progress-container" id="progressContainer">
                <h5><i class="fas fa-cog loading-spinner"></i> 正在處理中...</h5>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                </div>
                <p class="text-muted mt-2" id="progressText">準備處理...</p>
            </div>

            <!-- 結果區域 -->
            <div class="result-container" id="resultContainer">
                <div class="row">
                    <div class="col-md-8">
                        <div class="data-card">
                            <h5><i class="fas fa-table"></i> 提取的資料</h5>
                            <div id="extractedData"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="data-card">
                            <h5><i class="fas fa-chart-pie"></i> 處理摘要</h5>
                            <div id="dataSummary"></div>
                        </div>
                        
                        <div class="data-card">
                            <h5><i class="fas fa-check-circle"></i> 驗證結果</h5>
                            <div id="validationResult"></div>
                        </div>
                    </div>
                </div>

                <!-- 下載區域 -->
                <div class="download-section">
                    <h5><i class="fas fa-download"></i> 下載結果</h5>
                    <div id="downloadButtons"></div>
                </div>
            </div>

            <!-- 功能特色 -->
            <div class="feature-list">
                <h5><i class="fas fa-star"></i> 系統特色</h5>
                <div class="feature-item">
                    <i class="fas fa-eye feature-icon"></i>
                    <span>高精度OCR文字辨識，支援中文保單</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-file-pdf feature-icon"></i>
                    <span>自動生成PDF表單，格式標準化</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-shield-alt feature-icon"></i>
                    <span>資料驗證與錯誤檢查</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-chart-line feature-icon"></i>
                    <span>處理摘要報告</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全域變數
        let currentFile = null;
        let processingResult = null;

        // DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const resultContainer = document.getElementById('resultContainer');

        // 事件監聽器
        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('click', () => fileInput.click());

        // 檔案選擇處理
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // 拖拽處理
        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        // 檔案處理
        function processFile(file) {
            // 驗證檔案
            if (!validateFile(file)) {
                return;
            }

            currentFile = file;
            showProgress();
            uploadFile(file);
        }

        // 檔案驗證
        function validateFile(file) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/tiff', 'image/bmp', 'application/pdf'];
            const maxSize = 16 * 1024 * 1024; // 16MB

            if (!allowedTypes.includes(file.type)) {
                showAlert('錯誤', '不支援的檔案格式。請選擇 JPG, PNG, PDF, TIFF 或 BMP 檔案。', 'danger');
                return false;
            }

            if (file.size > maxSize) {
                showAlert('錯誤', '檔案大小超過限制 (最大16MB)。', 'danger');
                return false;
            }

            return true;
        }

        // 顯示進度
        function showProgress() {
            progressContainer.style.display = 'block';
            resultContainer.style.display = 'none';
            updateProgress(0, '準備上傳檔案...');
        }

        // 更新進度
        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
        }

        // 上傳檔案
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            updateProgress(20, '上傳檔案中...');

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                updateProgress(100, '處理完成！');
                setTimeout(() => {
                    showResult(data);
                }, 500);
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('錯誤', '處理失敗: ' + error.message, 'danger');
                hideProgress();
            });
        }

        // 顯示結果
        function showResult(data) {
            processingResult = data;
            hideProgress();
            displayExtractedData(data.extracted_data);
            displayDataSummary(data.data_summary);
            displayValidationResult(data.validation_result);
            displayDownloadButtons(data);
            resultContainer.style.display = 'block';
        }

        // 隱藏進度
        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        // 顯示提取的資料
        function displayExtractedData(data) {
            const container = document.getElementById('extractedData');
            const fieldLabels = {
                'insurance_company': '產險公司',
                'insured_section': '被保險人區塊',
                'insured_person': '被保險人',
                'legal_representative': '法人代表人',
                'id_number': '身分證字號/統編',
                'birth_date': '出生日期',
                'gender': '性別',
                'policyholder_section': '要保人區塊',
                'policyholder': '要保人',
                'relationship': '與被保險人關係',
                'policyholder_legal_representative': '要保人法人代表',
                'policyholder_gender': '要保人性別',
                'policyholder_id': '要保人身分證字號',
                'policyholder_birth_date': '要保人出生日期',
                'vehicle_type': '車輛種類',
                'license_number': '牌照號碼',
                'coverage_items': '承保內容',
                'total_premium': '總保險費'
            };

            // 定義欄位顯示順序
            const fieldOrder = [
                'insurance_company',
                'insured_person',
                'legal_representative',
                'id_number',
                'birth_date',
                'gender',
                'policyholder',
                'relationship',
                'policyholder_legal_representative',
                'policyholder_gender',
                'policyholder_id',
                'policyholder_birth_date',
                'vehicle_type',
                'license_number',
                'coverage_items',
                'total_premium'
            ];

            let html = '';
            // 按順序顯示主要欄位
            fieldOrder.forEach(key => {
                if (data.hasOwnProperty(key)) {
                    const label = fieldLabels[key] || key;
                    let value = data[key] || '未填寫';
                    // 專門處理 coverage_items
                    if (key === 'coverage_items') {
                        value = formatCoverageItems(value);
                    }
                    html += `
                        <div class="data-field">
                            <span class="field-label">${label}:</span>
                            <span class="field-value">${value}</span>
                        </div>
                    `;
                }
            });
            container.innerHTML = html;
        }

        // 專門渲染 coverage_items 陣列為表格
        function formatCoverageItems(items) {
            if (!items || !Array.isArray(items) || items.length === 0) {
                return '無資料';
            }
            let tableHtml = `
                <table class="insurance-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>保險種類</th>
                            <th>保險金額</th>
                            <th>自負額</th>
                            <th>簽單保費</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach((item, idx) => {
                tableHtml += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item['保險種類'] || ''}</td>
                        <td>${item['保險金額'] || ''}</td>
                        <td>${item['自負額'] || ''}</td>
                        <td>${item['簽單保費'] || ''}</td>
                    </tr>
                `;
                // 處理子項目
                if (Array.isArray(item.sub_items)) {
                    item.sub_items.forEach(sub => {
                        tableHtml += `
                            <tr class="sub-item-row">
                                <td></td>
                                <td>└ ${sub['保險種類'] || ''}</td>
                                <td>${sub['保險金額'] || ''}</td>
                                <td>${sub['自負額'] || ''}</td>
                                <td>${sub['簽單保費'] || ''}</td>
                            </tr>
                        `;
                    });
                }
            });
            tableHtml += `</tbody></table>`;
            return tableHtml;
        }
        
        // 顯示資料摘要
        function displayDataSummary(summary) {
            const container = document.getElementById('dataSummary');
            container.innerHTML = `
                <div class="data-field">
                    <span class="field-label">總欄位數:</span>
                    <span class="field-value">${summary.total_fields}</span>
                </div>
                <div class="data-field">
                    <span class="field-label">已填寫:</span>
                    <span class="field-value">${summary.filled_fields}</span>
                </div>
                <div class="data-field">
                    <span class="field-label">完成率:</span>
                    <span class="field-value">${summary.completion_rate}</span>
                </div>
            `;
        }

        // 顯示驗證結果
        function displayValidationResult(validation) {
            const container = document.getElementById('validationResult');
            let badgeClass = 'validation-success';
            let badgeText = '驗證通過';
            let icon = 'fas fa-check-circle';

            if (!validation.is_valid) {
                badgeClass = 'validation-error';
                badgeText = '需要改善';
                icon = 'fas fa-exclamation-triangle';
            } else if (validation.warnings && validation.warnings.length > 0) {
                badgeClass = 'validation-warning';
                badgeText = '有建議';
                icon = 'fas fa-info-circle';
            }

            let html = `
                <div class="text-center mb-3">
                    <span class="validation-badge ${badgeClass}">
                        <i class="${icon}"></i> ${badgeText}
                    </span>
                </div>
            `;

            // 顯示建議（正面訊息）
            if (validation.suggestions && validation.suggestions.length > 0) {
                html += '<div class="text-success mb-2"><strong><i class="fas fa-thumbs-up"></i> 狀態:</strong><br>';
                validation.suggestions.forEach(suggestion => {
                    html += `• ${suggestion}<br>`;
                });
                html += '</div>';
            }

            // 顯示缺失欄位
            if (validation.missing_fields && validation.missing_fields.length > 0) {
                html += '<div class="text-warning mb-2"><strong><i class="fas fa-exclamation-circle"></i> 未辨識欄位:</strong><br>';
                validation.missing_fields.forEach(field => {
                    html += `• 承保內容<br>`;
                });
                html += '</div>';
            }

            // 顯示格式警告
            if (validation.warnings && validation.warnings.length > 0) {
                html += '<div class="text-info mb-2"><strong><i class="fas fa-info-circle"></i> 格式提醒:</strong><br>';
                validation.warnings.forEach(warning => {
                    html += `• ${warning}<br>`;
                });
                html += '</div>';
            }

            // 顯示錯誤（如果有）
            if (validation.errors && validation.errors.length > 0) {
                html += '<div class="text-danger mb-2"><strong><i class="fas fa-times-circle"></i> 錯誤:</strong><br>';
                validation.errors.forEach(error => {
                    html += `• ${error}<br>`;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // 顯示下載按鈕
        function displayDownloadButtons(data) {
            const container = document.getElementById('downloadButtons');
            container.innerHTML = `
                <a href="/download/${data.pdf_filename}" class="btn btn-download">
                    <i class="fas fa-file-pdf"></i> 下載保單表單
                </a>
                <a href="/download/${data.report_filename}" class="btn btn-download">
                    <i class="fas fa-chart-bar"></i> 下載摘要報告
                </a>
            `;
        }

        // 顯示警告
        function showAlert(title, message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <strong>${title}</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.main-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 自動關閉
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html> 